<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teste de Storage MentalIA</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .test-section { margin: 20px 0; padding: 20px; border: 1px solid #ccc; border-radius: 8px; }
        button { padding: 10px 20px; margin: 5px; cursor: pointer; }
        .result { margin: 10px 0; padding: 10px; background: #f5f5f5; border-radius: 4px; }
        .error { background: #ffebee; border: 1px solid #f44336; }
        .success { background: #e8f5e8; border: 1px solid #4caf50; }
    </style>
</head>
<body>
    <h1>Teste de Storage MentalIA 3.1</h1>

    <div class="test-section">
        <h2>Teste BÃ¡sico de Storage</h2>
        <button onclick="testBasicStorage()">Testar Storage BÃ¡sico</button>
        <div id="basic-result" class="result"></div>
    </div>

    <div class="test-section">
        <h2>Salvar Entrada de Teste</h2>
        <button onclick="saveTestEntry()">Salvar Entrada de Teste</button>
        <div id="save-result" class="result"></div>
    </div>

    <div class="test-section">
        <h2>Carregar Todas as Entradas</h2>
        <button onclick="loadAllEntries()">Carregar Entradas</button>
        <div id="load-result" class="result"></div>
    </div>

    <div class="test-section">
        <h2>Verificar Chave de Criptografia</h2>
        <button onclick="checkEncryptionKey()">Verificar Chave</button>
        <div id="key-result" class="result"></div>
    </div>

    <div class="test-section">
        <h2>Limpar Dados (Cuidado!)</h2>
        <button onclick="clearAllData()" style="background: #f44336; color: white;">Limpar Tudo</button>
        <div id="clear-result" class="result"></div>
    </div>

    <script src="js/storage.js"></script>
    <script>
        function showResult(elementId, message, isError = false) {
            const element = document.getElementById(elementId);
            element.textContent = message;
            element.className = 'result ' + (isError ? 'error' : 'success');
        }

        async function testBasicStorage() {
            try {
                showResult('basic-result', 'Testando storage...');

                if (!window.mentalStorage) {
                    throw new Error('window.mentalStorage nÃ£o encontrado');
                }

                await window.mentalStorage.ensureInitialized();
                showResult('basic-result', 'âœ… Storage inicializado com sucesso!');
            } catch (error) {
                showResult('basic-result', 'âŒ Erro: ' + error.message, true);
                console.error('Erro no teste bÃ¡sico:', error);
            }
        }

        async function saveTestEntry() {
            try {
                showResult('save-result', 'Salvando entrada de teste...');

                const testEntry = {
                    id: Date.now(),
                    mood: 4.2,
                    feelings: [
                        { value: 'happy', category: 'positive', emoji: 'ðŸ˜Š', label: 'Feliz' },
                        { value: 'excited', category: 'positive', emoji: 'ðŸ¤©', label: 'Animado' }
                    ],
                    diary: 'Esta Ã© uma entrada de teste para verificar se o storage estÃ¡ funcionando.',
                    timestamp: new Date().toISOString(),
                    date: new Date().toDateString(),
                    version: '3.1'
                };

                const result = await window.mentalStorage.saveMoodEntry(testEntry);
                showResult('save-result', 'âœ… Entrada salva com sucesso! ID: ' + result.id);
            } catch (error) {
                showResult('save-result', 'âŒ Erro ao salvar: ' + error.message, true);
                console.error('Erro ao salvar:', error);
            }
        }

        async function loadAllEntries() {
            try {
                showResult('load-result', 'Carregando entradas...');

                const entries = await window.mentalStorage.getAllMoodEntries();
                const stats = await window.mentalStorage.getStats();

                let result = `âœ… ${entries.length} entradas carregadas\n`;
                result += `ðŸ“Š EstatÃ­sticas: ${stats.totalEntries} total, mÃ©dia ${stats.averageMood}, streak ${stats.streak}\n`;

                if (entries.length > 0) {
                    result += '\nÃšltimas entradas:\n';
                    entries.slice(0, 3).forEach(entry => {
                        result += `- ID ${entry.id}: Humor ${entry.mood}, ${entry.feelings.length} sentimentos\n`;
                    });
                }

                showResult('load-result', result);
            } catch (error) {
                showResult('load-result', 'âŒ Erro ao carregar: ' + error.message, true);
                console.error('Erro ao carregar:', error);
            }
        }

        async function checkEncryptionKey() {
            try {
                showResult('key-result', 'Verificando chave de criptografia...');

                const keyData = localStorage.getItem('mental-ia-encryption-key');
                if (keyData) {
                    showResult('key-result', 'âœ… Chave de criptografia encontrada no localStorage (comprimento: ' + keyData.length + ')');
                } else {
                    showResult('key-result', 'âš ï¸ Nenhuma chave de criptografia encontrada - serÃ¡ gerada na prÃ³xima operaÃ§Ã£o');
                }
            } catch (error) {
                showResult('key-result', 'âŒ Erro ao verificar chave: ' + error.message, true);
            }
        }

        async function clearAllData() {
            if (!confirm('âš ï¸ Isso irÃ¡ apagar TODOS os dados salvos! Tem certeza?')) {
                return;
            }

            try {
                showResult('clear-result', 'Limpando dados...');

                // Clear IndexedDB
                const deleteRequest = indexedDB.deleteDatabase('MentalIA-DB-v3.1');
                deleteRequest.onsuccess = () => {
                    console.log('IndexedDB deletado');
                };
                deleteRequest.onerror = () => {
                    console.error('Erro ao deletar IndexedDB');
                };

                // Clear localStorage
                localStorage.removeItem('mental-ia-encryption-key');

                showResult('clear-result', 'âœ… Dados limpos! Recarregue a pÃ¡gina para reinicializar.');
            } catch (error) {
                showResult('clear-result', 'âŒ Erro ao limpar: ' + error.message, true);
            }
        }

        // Auto-test on load
        window.addEventListener('load', () => {
            setTimeout(testBasicStorage, 1000);
        });
    </script>
</body>
</html>